<div class="container my-5">

  <!-- Barre de recherche et filtres -->
  <div class="p-4 bg-white shadow rounded-3 mb-4 border">
    <div class="row g-3 align-items-center">
      <div class="col-md-5">
        <input type="text"
               class="form-control shadow-sm"
               placeholder="üîç Rechercher nom, pr√©nom ou formation..."
               [(ngModel)]="searchText"
               (ngModelChange)="applyFilters()">
      </div>
      <div class="col-md-4">
        <select class="form-select shadow-sm"
                [(ngModel)]="selectedEtat"
                (ngModelChange)="applyFilters()">
          <option value="">üìå Tous les √©tats</option>
          <option value="PAIEMENT_CONFIRME">‚úîÔ∏è Accept√©e</option>
          <option value="EN_ATTENTE_DE_PAIEMENT">‚è≥ En attente</option>
        </select>
      </div>
      <div class="col-md-3 d-flex justify-content-end gap-2">
        <button class="btn btn-outline-primary btn-sm shadow-sm"
                (click)="openGroupedModal()">
          <i class="bi bi-layers"></i> Imprimer Liste Des Participants
        </button>
        <button class="btn btn-outline-danger btn-sm shadow-sm"
                (click)="resetFilters()">
          <i class="bi bi-x-circle me-1"></i> R√©initialiser Recherche
        </button>
      </div>
      <div class="d-flex justify-content-end mb-3">
        <button class="btn btn-outline-primary btn-sm shadow-sm" (click)="goToDashboard()">
          <i class="bi bi-arrow-left me-1"></i> Retour au Dashboard
        </button>
      </div>
    </div>
  </div>

  <!-- Tableau -->
  <div class="card shadow border-0 rounded-4">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center px-4 py-3 rounded-top">
      <h5 class="mb-0"><i class="bi bi-journal-text me-2"></i> Liste des inscriptions</h5>
      <span class="badge bg-light text-dark fw-bold fs-6 shadow-sm px-3 py-2 rounded-pill">
        {{ filteredInscriptions.length }} inscrits
      </span>
    </div>

    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover table-striped table-bordered align-middle mb-0">
          <thead class="table-light text-center text-uppercase small">
            <tr>
              <th>Nom</th>
              <th>Pr√©nom</th>
              <th>Email</th>
              <th>T√©l√©phone</th>
              <th>Titre Formation</th>
              <th>√âtat</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let insc of filteredInscriptions" class="text-center">
              <td class="fw-semibold">{{ insc.nom }}</td>
              <td class="fw-semibold">{{ insc.prenom }}</td>
              <td class="text-muted">{{ insc.email }}</td>
              <td>{{ insc.telephone || '-' }}</td>
              <td class="text-primary">{{ insc.formation?.titre }}</td>
              <td>
                <span class="badge d-inline-flex align-items-center gap-1 px-3 py-2 fs-6 rounded-pill"
                      [ngClass]="{
                        'bg-success': insc.etat === 'PAIEMENT_CONFIRME',
                        'bg-warning text-dark': insc.etat === 'EN_ATTENTE_DE_PAIEMENT'
                      }">
                  <i class="bi"
                     [ngClass]="{
                       'bi-check-circle-fill': insc.etat === 'PAIEMENT_CONFIRME',
                       'bi-clock-fill': insc.etat === 'EN_ATTENTE_DE_PAIEMENT'
                     }"></i>
                  {{ insc.etat === 'PAIEMENT_CONFIRME' ? 'Paiement confirm√©' : 'En attente de paiement' }}
                </span>
              </td>
              <td class="d-flex gap-2 justify-content-center">
                <button class="btn btn-sm btn-outline-secondary shadow-sm d-flex align-items-center gap-2"
                        (click)="openEditModal(insc)">
                  <i class="bi bi-pencil-square"></i>
                  Modifier
                </button>
                <button class="btn btn-sm btn-outline-danger shadow-sm d-flex align-items-center gap-2"
                        (click)="deleteInscription(insc.id)">
                  <i class="bi bi-trash3-fill"></i>
                  Supprimer
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>


<div class="modal fade" id="groupedModal" tabindex="-1" aria-labelledby="groupedModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content shadow border-0 rounded-4">
      <!-- En-t√™te du modal -->
      <div class="modal-header bg-dark text-white rounded-top">
        <h5 class="modal-title" id="groupedModalLabel">
          <i class="bi bi-layers me-2"></i> Inscriptions par formation
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Fermer"></button>
      </div>

      <!-- Corps du modal -->
      <div class="modal-body bg-light">
        <ng-container *ngIf="objectKeys(groupedInscriptions).length > 0; else noInscriptions">
          <div *ngFor="let titre of objectKeys(groupedInscriptions)" class="mb-5">
            <!-- Titre de formation + bouton -->
            <div class="d-flex justify-content-between align-items-center mb-2">
              <h6 class="fw-bold text-primary mb-0">{{ titre }}</h6>
              <button class="btn btn-sm btn-outline-primary"
                      (click)="downloadPdf(titre, groupedInscriptions[titre])">
                <i class="bi bi-printer me-1"></i> T√©l√©charger Cette Liste
              </button>
            </div>

            <!-- Tableau d‚Äôinscriptions -->
            <div class="table-responsive shadow-sm rounded overflow-hidden">
              <table class="table table-bordered table-sm align-middle text-center mb-0">
                <thead class="table-primary text-white small">
                  <tr>
                    <th>#</th>
                    <th>Nom complet</th>
                    <th>Email</th>
                    <th>T√©l√©phone</th>
                    <th>√âtat</th>
                    <th>Signature Entr√©e</th>
                    <th>Signature Sortie</th>
                  </tr>
                </thead>
                <tbody>
                  <tr *ngFor="let insc of groupedInscriptions[titre]; let i = index">
                    <td>{{ i + 1 }}</td>
                    <td class="text-start">{{ insc.prenom }} {{ insc.nom }}</td>
                    <td class="text-start">{{ insc.email }}</td>
                    <td>{{ insc.telephone || '-' }}</td>
                    <td>
                      <span [ngClass]="{
                        'text-success fw-bold': insc.etat === 'PAIEMENT_CONFIRME',
                        'text-warning fw-semibold': insc.etat !== 'PAIEMENT_CONFIRME'
                      }">
                        {{ insc.etat === 'PAIEMENT_CONFIRME' ? '‚úîÔ∏è Confirm√©' : '‚è≥ En attente' }}
                      </span>
                    </td>
                    <td></td>
                    <td></td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </ng-container>

        <!-- Si aucune inscription -->
        <ng-template #noInscriptions>
          <div class="text-center text-muted py-5">
            <i class="bi bi-info-circle fs-2 mb-3 d-block"></i>
            Aucune inscription trouv√©e pour impression.
          </div>
        </ng-template>
      </div>

      <!-- Pied du modal -->
      <div class="modal-footer bg-white rounded-bottom">
        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
          <i class="bi bi-x-circle me-1"></i> Fermer
        </button>
      </div>
    </div>
  </div>
</div>

<!-- ‚úÖ MODALE DE MISE √Ä JOUR -->
<div class="modal fade" id="editModal" tabindex="-1" aria-labelledby="editModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content border-0 shadow rounded-4">
      <div class="modal-header bg-primary text-white rounded-top">
        <h5 class="modal-title"><i class="bi bi-pencil-square me-2"></i> Modifier l'inscription</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

<form (ngSubmit)="submitUpdate()" #editForm="ngForm">
  <div class="modal-body bg-light rounded-bottom">
    <div class="row g-3">
      <div class="col-md-6">
        <label class="form-label">Pr√©nom</label>
        <input type="text" class="form-control" [(ngModel)]="selectedInscription.prenom" name="prenom" required>
      </div>
      <div class="col-md-6">
        <label class="form-label">Nom</label>
        <input type="text" class="form-control" [(ngModel)]="selectedInscription.nom" name="nom" required>
      </div>
      <div class="col-md-6">
        <label class="form-label">Email</label>
        <input type="email" class="form-control" [(ngModel)]="selectedInscription.email" name="email" required>
      </div>
      <div class="col-md-6">
        <label class="form-label">T√©l√©phone</label>
        <input type="text" class="form-control" [(ngModel)]="selectedInscription.telephone" name="telephone">
      </div>
      <div class="col-md-6">
        <label class="form-label">√âtat</label>
        <select class="form-select" [(ngModel)]="selectedInscription.etat" name="etat">
          <option value="EN_ATTENTE_DE_PAIEMENT">‚è≥ En attente</option>
          <option value="PAIEMENT_CONFIRME">‚úîÔ∏è Confirm√©</option>
        </select>
      </div>
      <div class="col-md-6">
        <label class="form-label">Formation (non modifiable)</label>
        <input type="text" class="form-control text-muted" [value]="selectedInscription.formation?.titre" disabled>
      </div>
    </div>
  </div>
  <div class="modal-footer bg-white rounded-bottom">
    <button type="submit" class="btn btn-success">
      <i class="bi bi-check2-circle me-1"></i> Enregistrer
    </button>
    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
      Annuler
    </button>
  </div>
</form>
    </div>
  </div>
</div>


<footer class="text-center py-3 bg-light border-top mt-4">
  <div class="small text-muted">
    &copy; {{ currentYear || '2025' }} <strong class="text-dark">SMS2I</strong> ‚Äî Tous droits r√©serv√©s.
  </div>
  <div class="small">
    Con√ßu <i class="bi bi-heart-fill text-danger mx-1"></i> par l‚Äô√©quipe <span class="text-primary fw-semibold">SMS2I</span>
  </div>
</footer>
