<div class="container my-5">

  <!-- Barre de recherche et filtres -->
  <div class="p-4 bg-white shadow rounded-3 mb-4 border">
    <div class="row g-3 align-items-center">
      <div class="col-md-5">
        <input type="text"
               class="form-control shadow-sm"
               placeholder="üîç Rechercher nom, pr√©nom ou formation..."
               [(ngModel)]="searchText"
               (ngModelChange)="applyFilters()">
      </div>
      <div class="col-md-4">
        <select class="form-select shadow-sm"
                [(ngModel)]="selectedEtat"
                (ngModelChange)="applyFilters()">
          <option value="">üìå Tous les √©tats</option>
          <option value="PAIEMENT_CONFIRME">‚úîÔ∏è Accept√©e</option>
          <option value="EN_ATTENTE_DE_PAIEMENT">‚è≥ En attente</option>
        </select>
      </div>
      <div class="col-md-3 d-flex justify-content-end gap-2">
        <button class="btn btn-outline-primary btn-sm shadow-sm"
                (click)="openGroupedModal()">
          <i class="bi bi-layers"></i> Par formation
        </button>
        <button class="btn btn-outline-danger btn-sm shadow-sm"
                (click)="resetFilters()">
          <i class="bi bi-x-circle me-1"></i> R√©initialiser
        </button>
      </div>
    </div>
  </div>

  <!-- Carte avec tableau -->
  <div class="card shadow border-0 rounded-4">
    <div class="card-header bg-primary text-white d-flex justify-content-between align-items-center px-4 py-3 rounded-top">
      <h5 class="mb-0"><i class="bi bi-journal-text me-2"></i> Liste des inscriptions</h5>
      <span class="badge bg-light text-dark fw-bold fs-6 shadow-sm px-3 py-2 rounded-pill">
        {{ filteredInscriptions.length }} inscrits
      </span>
    </div>

    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover table-striped table-bordered align-middle mb-0">
          <thead class="table-light text-center text-uppercase small">
            <tr>
              <th>Nom</th>
              <th>Pr√©nom</th>
              <th>Email</th>
              <th>T√©l√©phone</th>
              <th>Formation</th>
              <th>√âtat</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            <tr *ngFor="let insc of filteredInscriptions" class="text-center">
              <td class="fw-semibold">{{ insc.nom }}</td>
              <td class="fw-semibold">{{ insc.prenom }}</td>
              <td class="text-muted">{{ insc.email }}</td>
              <td>{{ insc.telephone || '-' }}</td>
              <td class="text-primary">{{ insc.formation.titre }}</td>
              <td>
                <span class="badge d-inline-flex align-items-center gap-1 px-3 py-2 fs-6 rounded-pill"
                      [ngClass]="{
                        'bg-success': insc.etat === 'PAIEMENT_CONFIRME',
                        'bg-warning text-dark': insc.etat === 'EN_ATTENTE_DE_PAIEMENT'
                      }">
                  <i class="bi"
                     [ngClass]="{
                       'bi-check-circle-fill': insc.etat === 'PAIEMENT_CONFIRME',
                       'bi-clock-fill': insc.etat === 'EN_ATTENTE_DE_PAIEMENT'
                     }"></i>
                  <span>
                    {{ insc.etat === 'PAIEMENT_CONFIRME' ? 'Paiement confirm√©' : 'En attente de paiement' }}
                  </span>
                </span>
              </td>
              <td>
                <button class="btn btn-sm btn-outline-danger shadow-sm d-flex align-items-center justify-content-center gap-2"
                        (click)="deleteInscription(insc.id)">
                  <i class="bi bi-trash3-fill"></i>
                  Supprimer
                </button>
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Modal regroup√© par formation -->
<div class="modal fade" id="groupedModal" tabindex="-1" aria-labelledby="groupedModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-xl modal-dialog-scrollable">
    <div class="modal-content border-0 shadow rounded-4">
      <div class="modal-header bg-primary text-white rounded-top">
        <h5 class="modal-title">
          <i class="bi bi-collection me-2"></i> Inscriptions regroup√©es par formation
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <div class="modal-body bg-light rounded-bottom">
        <div *ngFor="let group of groupedInscriptions | keyvalue" class="mb-5 p-3 bg-white shadow-sm rounded-3 border">

          <!-- En-t√™te formation -->
          <div class="d-flex justify-content-between align-items-center mb-3">
            <h5 class="text-primary mb-0 fw-bold">
              üìò {{ group.key }} <span class="text-muted fs-6">({{ group.value.length }} inscrit(s))</span>
            </h5>
            <button class="btn btn-sm btn-outline-primary" (click)="downloadPdf(group.key, group.value)">
              <i class="bi bi-file-earmark-arrow-down me-1"></i> T√©l√©charger PDF
            </button>
          </div>

          <!-- Table des inscrits -->
          <div class="table-responsive">
            <table class="table table-bordered table-hover align-middle mb-0">
              <thead class="table-light text-center">
                <tr>
                  <th>#</th>
                  <th>Nom complet</th>
                  <th>Email</th>
                  <th>T√©l√©phone</th>
                  <th>√âtat</th>
                </tr>
              </thead>
              <tbody>
                <tr *ngFor="let insc of group.value; let i = index" class="text-center">
                  <td>{{ i + 1 }}</td>
                  <td class="fw-semibold text-start">{{ insc.prenom }} {{ insc.nom }}</td>
                  <td class="text-muted text-start">{{ insc.email }}</td>
                  <td>{{ insc.telephone || '-' }}</td>
                  <td>
                    <span class="badge rounded-pill px-3 py-2 fs-6 d-inline-flex align-items-center gap-1"
                          [ngClass]="{
                            'bg-success': insc.etat === 'PAIEMENT_CONFIRME',
                            'bg-warning text-dark': insc.etat === 'EN_ATTENTE_DE_PAIEMENT'
                          }">
                      <i class="bi"
                         [ngClass]="{
                           'bi-check-circle-fill': insc.etat === 'PAIEMENT_CONFIRME',
                           'bi-clock-fill': insc.etat === 'EN_ATTENTE_DE_PAIEMENT'
                         }"></i>
                      {{ insc.etat === 'PAIEMENT_CONFIRME' ? 'Confirm√©' : 'En attente' }}
                    </span>
                  </td>
                </tr>
              </tbody>
            </table>
          </div>

        </div>
      </div>
    </div>
  </div>
</div>

<footer class="text-center py-3 bg-light border-top mt-4">
  <div class="small text-muted">
    &copy; {{ currentYear || '2025' }} <strong class="text-dark">SMS2I</strong> ‚Äî Tous droits r√©serv√©s.
  </div>
  <div class="small">
    Con√ßu <i class="bi bi-heart-fill text-danger mx-1"></i> par l‚Äô√©quipe <span class="text-primary fw-semibold">SMS2I</span>
  </div>
</footer>
